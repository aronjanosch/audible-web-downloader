<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Audible Book Downloader{% endblock %}</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <style>
        .book-card {
            transition: transform 0.2s;
            height: 100%;
        }
        .book-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .book-cover {
            height: 200px;
            object-fit: cover;
            width: 100%;
        }
        .sidebar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: white;
        }
        .main-content {
            background-color: #f8f9fa;
            min-height: 100vh;
        }
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
        }
        .btn-primary:hover {
            background: linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%);
        }
        .loading {
            display: none;
        }
        .loading.show {
            display: block;
        }
        .book-selected {
            border: 3px solid #28a745 !important;
        }
        .status-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            display: none;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            font-weight: bold;
            text-align: center;
            z-index: 10;
        }
        .book-card {
            position: relative;
        }
        .progress-container {
            z-index: 11;
        }
        .progress-text {
            font-size: 0.7rem !important;
        }
        .progress-circle-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 10;
            border-radius: 0.375rem 0.375rem 0 0;
        }
        .progress-circle {
            transform: rotate(-90deg);
        }
        .progress-circle-text {
            position: absolute;
            color: white;
            font-weight: bold;
            font-size: 1.1rem;
        }
        .progress-circle-status {
            color: white;
            font-size: 0.8rem;
            margin-top: 5px;
            text-align: center;
        }
        .view-switcher .btn {
            background-color: #e9ecef;
            border-color: #ced4da;
            color: #495057;
        }
        .view-switcher .btn.active {
            background-color: #007bff;
            border-color: #007bff;
            color: white;
        }
        .book-list-item {
            display: flex;
            align-items: center;
            padding: 1rem;
            border-bottom: 1px solid #dee2e6;
            transition: background-color 0.2s;
        }
        .book-list-item:hover {
            background-color: #f8f9fa;
        }
        .book-list-item .book-cover {
            width: 50px;
            height: 75px;
            margin-right: 1rem;
        }
        .book-list-item .book-info {
            flex-grow: 1;
            margin-right: 15px;
        }
        .book-list-item .status-text {
            min-width: 150px;
            text-align: right;
            font-weight: bold;
            font-size: 0.9rem;
        }
        .status-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            color: white;
            display: flex;
            justify-content: center;
            align-items: center;
            text-align: center;
            padding: 1rem;
            font-size: 1.2rem;
            display: none;
        }
        .book-missing {
            border: 2px solid #dc3545 !important;
        }
        .book-available {
            border: 2px solid #28a745 !important;
        }
        .filter-tabs {
            margin-bottom: 1rem;
        }
        .library-filter {
            background: none;
            border: 1px solid #dee2e6;
            color: #495057;
            margin-right: 0.5rem;
            margin-bottom: 0.5rem;
        }
        .library-filter.active {
            background: #007bff;
            border-color: #007bff;
            color: white;
        }
    </style>
    
    {% block extra_css %}{% endblock %}
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            {% if not hide_sidebar %}
            <!-- Sidebar -->
            <div class="col-md-3 col-lg-2 sidebar p-4">
                <h3 class="mb-4">
                    <i class="fas fa-book"></i> Audible Downloader
                </h3>
                
                <!-- Account Management -->
                <div class="mb-4">
                    <h5>Account Management</h5>
                    
                    <!-- Account Selector -->
                    <div class="mb-3">
                        <label for="accountSelect" class="form-label">Select Account:</label>
                        <select class="form-select" id="accountSelect">
                            <option value="">No accounts configured</option>
                        </select>
                    </div>
                    
                    <!-- Add New Account -->
                    <div class="card bg-light text-dark">
                        <div class="card-body">
                            <h6 class="card-title">Add New Account</h6>
                            <form id="addAccountForm">
                                <div class="mb-2">
                                    <input type="text" class="form-control form-control-sm" 
                                           id="accountName" placeholder="Account Name" required>
                                </div>
                                <div class="mb-2">
                                    <select class="form-select form-select-sm" id="accountRegion">
                                        <option value="us">United States</option>
                                        <option value="uk">United Kingdom</option>
                                        <option value="de">Germany</option>
                                        <option value="fr">France</option>
                                        <option value="ca">Canada</option>
                                        <option value="it">Italy</option>
                                        <option value="au">Australia</option>
                                        <option value="in">India</option>
                                        <option value="jp">Japan</option>
                                        <option value="es">Spain</option>
                                        <option value="br">Brazil</option>
                                    </select>
                                </div>
                                <button type="submit" class="btn btn-light btn-sm w-100">
                                    <i class="fas fa-plus"></i> Add Account
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
                
                <!-- Account Status -->
                <div id="accountStatus" class="mb-4" style="display: none;">
                    <h5>Account Status</h5>
                    <div id="authStatus" class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle"></i> Not authenticated
                    </div>
                    <div class="d-grid gap-2">
                        <button id="authenticateBtn" class="btn btn-warning btn-sm">
                            <i class="fas fa-sign-in-alt"></i> Login to Audible
                        </button>
                        <button id="generateAccountInviteBtn" class="btn btn-outline-light btn-sm" style="display: none;">
                            <i class="fas fa-link"></i> Generate Invite Link
                        </button>
                        <button id="refreshLibraryBtn" class="btn btn-info btn-sm" style="display: none;">
                            <i class="fas fa-sync"></i> Refresh Library
                        </button>
                    </div>
                </div>
                
                <!-- Libraries Management -->
                <div id="librariesSection" class="mb-4">
                    <h5>Download Libraries</h5>

                    <!-- Add New Library -->
                    <div class="card bg-light text-dark mb-3">
                        <div class="card-body">
                            <h6 class="card-title">Add Library</h6>
                            <form id="addLibraryForm">
                                <div class="mb-2">
                                    <input type="text" class="form-control form-control-sm"
                                           id="libraryName" placeholder="Library Name (e.g., English)" required>
                                </div>
                                <div class="mb-2">
                                    <input type="text" class="form-control form-control-sm"
                                           id="libraryPath" placeholder="Library Path" required>
                                </div>
                                <button type="submit" class="btn btn-light btn-sm w-100">
                                    <i class="fas fa-plus"></i> Add Library
                                </button>
                            </form>
                        </div>
                    </div>

                    <!-- Library List -->
                    <div id="configuredLibraryList" class="mb-3">
                        <small class="text-light">No libraries configured</small>
                    </div>

                    <!-- Sync Library Button -->
                    <div id="syncLibrarySection" style="display: none;">
                        <button type="button" class="btn btn-outline-light btn-sm w-100" id="syncLibraryBtn">
                            <i class="fas fa-sync-alt"></i> Sync Library
                        </button>
                        <small class="form-text text-light d-block mt-1">
                            Scan library and update download history
                        </small>
                    </div>
                </div>
                
                <!-- Download Controls -->
                <div id="downloadControls" class="mb-4" style="display: none;">
                    <h5>Download Settings</h5>

                    <!-- Library Selection -->
                    <div class="mb-3">
                        <label for="downloadLibrarySelect" class="form-label">Download to library: <span class="text-danger">*</span></label>
                        <select class="form-select form-select-sm" id="downloadLibrarySelect" required>
                            <option value="">Select a library...</option>
                        </select>
                        <small class="text-light">Configure a library above first</small>
                    </div>

                    <!-- Naming Pattern Configuration -->
                    <div class="mb-3">
                        <button type="button" class="btn btn-outline-light btn-sm w-100" id="configureNamingBtn">
                            <i class="fas fa-cog"></i> Configure Naming Pattern
                        </button>
                    </div>

                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="cleanupAax" checked>
                        <label class="form-check-label" for="cleanupAax">
                            Clean up AAX files after conversion
                        </label>
                    </div>
                    <div class="d-grid gap-2 mt-3">
                        <button id="downloadBtn" class="btn btn-success btn-sm">
                            <i class="fas fa-download"></i> Download Selected
                        </button>
                    </div>
                </div>

                <!-- Family Sharing Button -->
                <div class="mb-4">
                    <h5>Family Sharing</h5>
                    <button type="button" class="btn btn-outline-light btn-sm w-100" id="familySharingBtn">
                        <i class="fas fa-users"></i> Manage Invitation Link
                    </button>
                </div>
            </div>
            {% endif %}

            <!-- Main Content -->
            <div class="{% if hide_sidebar %}col-12{% else %}col-md-9 col-lg-10{% endif %} main-content p-4">
                {% block content %}{% endblock %}
            </div>
        </div>
    </div>

    <!-- Family Sharing Modal -->
    <div class="modal fade" id="familySharingModal" tabindex="-1" aria-labelledby="familySharingModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="familySharingModalLabel">
                        <i class="fas fa-users me-2"></i>Family Sharing - Invitation Link
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- Information -->
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>How it works:</strong> Share this link with family members to let them add their Audible accounts to your app.
                        They will complete the Audible login, and you'll have full control to download from their library.
                    </div>

                    <!-- Current Invitation Link -->
                    <div class="mb-4">
                        <label for="invitationLinkDisplay" class="form-label fw-bold">Current Invitation Link</label>
                        <div class="input-group mb-2">
                            <input type="text" class="form-control font-monospace" id="invitationLinkDisplay" readonly value="Loading...">
                            <button class="btn btn-outline-primary" type="button" id="copyInviteLinkModalBtn" title="Copy to clipboard">
                                <i class="fas fa-copy"></i> Copy
                            </button>
                        </div>
                        <small class="text-muted">
                            <i class="fas fa-lock me-1"></i>Keep this link private within your family
                        </small>
                    </div>

                    <hr>

                    <!-- Custom Token Setting -->
                    <div class="mb-4">
                        <label for="customInvitationToken" class="form-label fw-bold">Custom Invitation Token</label>
                        <p class="small text-muted mb-2">
                            Set a custom token to create a memorable invitation link. Leave empty to auto-generate a secure random token.
                        </p>
                        <div class="input-group mb-2">
                            <input type="text" class="form-control font-monospace" id="customInvitationToken"
                                   placeholder="e.g., my-family-2024 (only letters, numbers, hyphens, underscores)"
                                   pattern="[a-zA-Z0-9_-]+">
                            <button class="btn btn-primary" type="button" id="saveCustomTokenBtn">
                                <i class="fas fa-save"></i> Set Token
                            </button>
                        </div>
                        <small class="text-muted">
                            <i class="fas fa-exclamation-triangle me-1"></i>
                            <strong>Security Note:</strong> Custom tokens should be at least 16 characters long and hard to guess.
                            Auto-generated tokens are more secure.
                        </small>
                    </div>

                    <hr>

                    <!-- Regenerate Token -->
                    <div class="mb-3">
                        <label class="form-label fw-bold">Generate New Random Token</label>
                        <p class="small text-muted mb-2">
                            Generate a new secure random token. This will invalidate the current invitation link.
                        </p>
                        <button type="button" class="btn btn-warning w-100" id="regenerateTokenModalBtn">
                            <i class="fas fa-sync"></i> Generate New Random Token
                        </button>
                    </div>

                    <!-- Status Message -->
                    <div id="familySharingStatus" class="mt-3">
                        <div class="alert d-none" id="familySharingStatusMessage" role="alert"></div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Account Invite Link Modal -->
    <div class="modal fade" id="accountInviteModal" tabindex="-1" aria-labelledby="accountInviteModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="accountInviteModalLabel">
                        <i class="fas fa-user-plus me-2"></i>Account Invitation Link
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- Information -->
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>How it works:</strong> Share this link with the person who should authenticate this specific account.
                        They will complete the Audible login for account <strong id="accountInviteAccountName"></strong>.
                    </div>

                    <!-- Account Details -->
                    <div class="mb-4">
                        <h6 class="fw-bold">Account Details</h6>
                        <table class="table table-sm">
                            <tr>
                                <td><strong>Account Name:</strong></td>
                                <td><code id="accountInviteDisplayName"></code></td>
                            </tr>
                            <tr>
                                <td><strong>Region:</strong></td>
                                <td><span id="accountInviteRegion"></span></td>
                            </tr>
                            <tr>
                                <td><strong>Status:</strong></td>
                                <td><span class="badge bg-warning" id="accountInviteStatus">Pending Authentication</span></td>
                            </tr>
                        </table>
                    </div>

                    <!-- Invitation Link Display -->
                    <div id="accountInviteLinkSection" style="display: none;">
                        <label for="accountInviteLinkDisplay" class="form-label fw-bold">Invitation Link</label>
                        <div class="input-group mb-2">
                            <input type="text" class="form-control font-monospace" id="accountInviteLinkDisplay" readonly>
                            <button class="btn btn-outline-primary" type="button" id="copyAccountInviteLinkBtn" title="Copy to clipboard">
                                <i class="fas fa-copy"></i> Copy
                            </button>
                        </div>
                        <small class="text-muted d-block mb-3">
                            <i class="fas fa-lock me-1"></i>This link is specific to this account only
                        </small>

                        <button type="button" class="btn btn-outline-danger btn-sm w-100" id="revokeAccountInviteBtn">
                            <i class="fas fa-times"></i> Revoke Invitation Link
                        </button>
                    </div>

                    <!-- Generate Link Section -->
                    <div id="generateAccountInviteSection">
                        <button type="button" class="btn btn-primary w-100" id="generateAccountInviteLinkBtn">
                            <i class="fas fa-link"></i> Generate Invitation Link
                        </button>
                    </div>

                    <!-- Status Message -->
                    <div id="accountInviteStatus" class="mt-3">
                        <div class="alert d-none" id="accountInviteStatusMessage" role="alert"></div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Naming Pattern Settings Modal -->
    <div class="modal fade" id="namingPatternModal" tabindex="-1" aria-labelledby="namingPatternModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="namingPatternModalLabel">Configure Naming Pattern</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- Preset Selection -->
                    <div class="mb-3">
                        <label for="namingPreset" class="form-label">Preset Templates</label>
                        <select class="form-select" id="namingPreset">
                            <option value="audiobookshelf">AudioBookshelf (Recommended)</option>
                            <option value="flat">Flat Structure</option>
                            <option value="author_title">Author/Title</option>
                            <option value="series_focused">Series Focused</option>
                            <option value="custom">Custom</option>
                        </select>
                        <small class="form-text text-muted" id="presetDescription">
                            Organizes by Author/Series/Title folders with metadata in folder name
                        </small>
                    </div>

                    <!-- Custom Pattern Input -->
                    <div class="mb-3">
                        <label for="customPattern" class="form-label">Custom Naming Pattern</label>
                        <input type="text" class="form-control font-monospace" id="customPattern"
                               placeholder="{{ '{Author}/{Series}/Vol. {Volume} - {Year} - {Title} {' }}{{ '{' }}{{ '{Narrator}' }}{{ '}' }}{{ '}.m4b' }}">
                        <div class="form-text">
                            <strong>Available Placeholders:</strong>
                            <div class="row mt-2">
                                <div class="col-md-6">
                                    <ul class="small mb-0">
                                        <li><code>{Author}</code> - Author name(s)</li>
                                        <li><code>{Series}</code> - Series name</li>
                                        <li><code>{Title}</code> - Book title only</li>
                                        <li><code>{Year}</code> - Release year</li>
                                        <li><code>{Volume}</code> - Series # (1, 2, 3...)</li>
                                    </ul>
                                </div>
                                <div class="col-md-6">
                                    <ul class="small mb-0">
                                        <li><code>{Narrator}</code> - Narrator name(s)</li>
                                        <li><code>{Publisher}</code> - Publisher name</li>
                                        <li><code>{Language}</code> - Language code</li>
                                        <li><code>{ASIN}</code> - Amazon ID</li>
                                        <li>Pattern must end with <code>.m4b</code></li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Preview Section -->
                    <div class="mb-3">
                        <label class="form-label">Preview</label>
                        <div class="card bg-light">
                            <div class="card-body">
                                <small class="font-monospace" id="patternPreview">
                                    Edgar Allan Poe/Erzählungen 1/Vol. 1 - 2024 - Edgar Allan Poe: Erzählungen 1 {Edgar Allan Poe}.m4b
                                </small>
                            </div>
                        </div>
                        <small class="form-text text-muted">
                            Example: "Vol. 1 - 2024 - Edgar Allan Poe: Erzählungen 1 {Edgar Allan Poe}.m4b"
                        </small>
                    </div>

                    <!-- Validation Messages -->
                    <div id="patternValidation" class="alert" style="display: none;"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="saveNamingPattern">Save Pattern</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Main JavaScript -->
    <script>
        // Global variables
        let currentAccount = null;
        let library = [];
        let selectedBooks = new Set();
        
        // Utility functions
        function showAlert(message, type = 'info') {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.querySelector('.main-content').insertBefore(alertDiv, document.querySelector('.main-content').firstChild);
            
            // Auto-dismiss after 5 seconds
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.remove();
                }
            }, 5000);
        }
        
        function showLoading(element, show = true) {
            if (show) {
                element.disabled = true;
                element.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Loading...';
            } else {
                element.disabled = false;
                element.innerHTML = element.getAttribute('data-original-text') || element.innerHTML;
            }
        }
        
        // API functions
        async function apiCall(url, options = {}) {
            try {
                const response = await fetch(url, {
                    headers: {
                        'Content-Type': 'application/json',
                        ...options.headers
                    },
                    ...options
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || 'API request failed');
                }
                
                return data;
            } catch (error) {
                console.error('API Error:', error);
                throw error;
            }
        }
        
        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            loadAccounts();
            setupEventListeners();
        });
    </script>
    
    {% block extra_js %}{% endblock %}
</body>
</html>